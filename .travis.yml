language: ruby
git:
  depth: false  # "Shallow clone detected during the analysis"
matrix:
  fast_finish: true
  include:
  # minimum supported versions
  - rvm: 2.4.4
  - rvm: truffleruby-1.0.0-rc11
  # latest releases
  - rvm: truffleruby
  - rvm: 2.4
  - rvm: 2.5
  - rvm: 2.6
    env: 
      - WITH_SONAR_ANALYSIS=true
      - SONAR_SCANNER_VERSION=3.3.0.1492
install:
  - |
    test $WITH_SONAR_ANALYSIS \
       && wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION.zip \
       && unzip sonar-scanner-cli-$SONAR_SCANNER_VERSION.zip || echo 'Skipping Sonar Scanner installation'  
script: 
  - gem build *.gemspec
  - gem install *.gem 
  - rake test
after_success:
  - |
    test $WITH_SONAR_ANALYSIS && sonar-scanner-$SONAR_SCANNER_VERSION/bin/sonar-scanner \
      -Dsonar.projectName=$SONAR_PROJECT_NAME \
      -Dsonar.projectKey=$SONAR_PROJECT_KEY \
      -Dsonar.organization=$SONAR_ORGANIZATION_KEY \
      -Dsonar.sources=./src \
      -Dsonar.tests=./test \
      -Dsonar.host.url=$SONAR_URL \
      -Dsonar.login=$SONAR_TOKEN || echo 'Skipping Sonar Scanner execution'  